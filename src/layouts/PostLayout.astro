---
// =============================================================================
// Post Layout - Layout for blog posts
// =============================================================================

import BaseLayout from './BaseLayout.astro';
import PostMeta from '@/components/blog/PostMeta.astro';
import TableOfContents from '@/components/layout/TableOfContents.astro';
import SeriesNav from '@/components/blog/SeriesNav.astro';
import RelatedPosts from '@/components/blog/RelatedPosts.astro';
import Giscus from '@/components/blog/Giscus.astro';
import { isFeatureEnabled } from '@/config';
import { getSeriesNavigation, getRelatedPosts, calculateReadingTime, type Post } from '@/lib/posts';
import { getUrlPrefix } from '@/lib/i18n';
import type { MarkdownHeading } from 'astro';

interface Props {
  post: Post;
  headings: MarkdownHeading[];
  alternateLocaleUrl?: string | null;
}

const { post, headings, alternateLocaleUrl } = Astro.props;
const { data, body } = post;

const readingTime = calculateReadingTime(body);

// URL prefix for locale-aware links (now uses /pt or /en)
const urlPrefix = getUrlPrefix(data.locale);

// Get series navigation if post is part of a series
const seriesNav = data.series ? await getSeriesNavigation(post) : null;

// Get related posts
const relatedPosts = isFeatureEnabled('relatedPosts')
  ? await getRelatedPosts(post)
  : [];

---

<BaseLayout
  title={data.title}
  description={data.description}
  ogImage={data.ogImage?.src}
  canonicalUrl={data.canonicalUrl}
  noIndex={data.noIndex}
  locale={data.locale}
  type="article"
  publishedAt={data.publishedAt}
  updatedAt={data.updatedAt}
  tags={data.tags}
  alternateUrl={alternateLocaleUrl}
>
  <article class="py-8">
    <div class="container mx-auto px-4">
      <!-- Article Header -->
      <header class="max-w-3xl mx-auto mb-8">
        <!-- Category badge -->
        <a
          href={`${urlPrefix}/categories/${data.category}`}
          class="badge badge-primary badge-sm mb-3"
        >
          {data.category}
        </a>

        <!-- Title -->
        <h1 class="text-3xl md:text-4xl font-bold text-base-content mb-3 leading-tight">
          {data.title}
        </h1>

        <!-- Description -->
        <p class="text-lg text-base-content/70 mb-4">
          {data.description}
        </p>

        <!-- Meta info -->
        <PostMeta
          publishedAt={data.publishedAt}
          updatedAt={data.updatedAt}
          readingTime={readingTime}
          locale={data.locale}
          tags={data.tags}
        />

        <!-- Translation notice -->
        {
          alternateLocaleUrl && (
            <div class="mt-3 p-2 px-3 bg-base-200 rounded-lg inline-block">
              <p class="text-sm text-base-content/70">
                {data.locale === 'pt' ? (
                  <>
                    Also in{' '}
                    <a href={alternateLocaleUrl} class="link link-primary">
                      English
                    </a>
                  </>
                ) : (
                  <>
                    Tamb√©m em{' '}
                    <a href={alternateLocaleUrl} class="link link-primary">
                      Portugu√™s
                    </a>
                  </>
                )}
              </p>
            </div>
          )
        }

        <!-- Series indicator - Collapsible style -->
        {
          data.series && seriesNav && seriesNav.allPosts.length > 0 && (
            <details class="mt-4 group" open>
              <summary class="flex items-center gap-3 p-3 bg-gradient-to-r from-primary/10 to-secondary/10 rounded-lg cursor-pointer hover:from-primary/15 hover:to-secondary/15 transition-colors">
                <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-primary/20 text-primary">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                </div>
                <div class="flex-1">
                  <span class="text-xs text-base-content/60 uppercase tracking-wider">
                    {data.locale === 'pt' ? 'S√©rie' : 'Series'}
                  </span>
                  <span class="block font-semibold text-base-content">
                    {seriesNav.seriesName}
                  </span>
                </div>
                <span class="badge badge-sm badge-ghost">
                  {seriesNav.current}/{seriesNav.total}
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-base-content/50 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>

              <div class="mt-2 p-3 bg-base-200/50 rounded-lg border border-base-300">
                <div class="space-y-1">
                  {seriesNav.allPosts.map((seriesPost, index) => {
                    const isCurrent = seriesPost.id === post.id;
                    const postSlug = seriesPost.id.split('/').pop();
                    return (
                      <a
                        href={isCurrent ? '#' : `${urlPrefix}/${postSlug}`}
                        class:list={[
                          'flex items-center gap-2 py-1.5 px-2 rounded text-sm transition-colors',
                          isCurrent
                            ? 'bg-primary/10 text-primary font-medium'
                            : 'hover:bg-base-300/50 text-base-content/70 hover:text-base-content',
                        ]}
                      >
                        <span class:list={[
                          'flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold shrink-0',
                          isCurrent
                            ? 'bg-primary text-primary-content'
                            : 'bg-base-300 text-base-content/60',
                        ]}>
                          {index + 1}
                        </span>
                        <span class="truncate">{seriesPost.data.title}</span>
                        {isCurrent && (
                          <span class="ml-auto text-xs text-primary">‚Üê</span>
                        )}
                      </a>
                    );
                  })}
                </div>
              </div>
            </details>
          )
        }
      </header>

      <!-- Main content area -->
      <div class="max-w-7xl mx-auto">
        <div class="lg:grid lg:grid-cols-[1fr_220px] lg:gap-8">
          <!-- Article content -->
          <div class="max-w-3xl">
            <!-- Cover image -->
            {
              data.coverImage && (
                <figure class="mb-6">
                  <img
                    src={data.coverImage.src}
                    alt={data.coverImageAlt || data.title}
                    class="w-full rounded-lg shadow-md"
                    loading="eager"
                  />
                  {data.coverImageAlt && (
                    <figcaption class="text-center text-sm text-base-content/60 mt-2">
                      {data.coverImageAlt}
                    </figcaption>
                  )}
                </figure>
              )
            }

            <!-- MDX Content -->
            <div class="prose-custom">
              <slot />
            </div>

            <!-- Series Navigation -->
            {
              data.series && seriesNav && isFeatureEnabled('seriesNavigation') && (
                <SeriesNav
                  previous={seriesNav.previous}
                  next={seriesNav.next}
                  locale={data.locale}
                />
              )
            }

            <!-- Tags -->
            <div class="mt-8 pt-6 border-t border-base-200">
              <div class="flex flex-wrap items-center gap-2">
                <span class="text-xs font-medium text-base-content/50 uppercase tracking-wider">Tags:</span>
                {
                  data.tags.map((tag) => (
                    <a
                      href={`${urlPrefix}/tags/${tag}`}
                      class="text-xs px-2 py-1 rounded-full bg-base-200 text-base-content/70 hover:bg-primary hover:text-primary-content transition-colors"
                    >
                      #{tag}
                    </a>
                  ))
                }
              </div>
            </div>

            <!-- Related Posts -->
            {
              relatedPosts.length > 0 && (
                <RelatedPosts posts={relatedPosts} locale={data.locale} />
              )
            }

            <!-- Comments -->
            {
              data.comments && isFeatureEnabled('giscus') && (
                <div class="mt-8 pt-6 border-t border-base-200">
                  <h3 class="text-lg font-bold text-base-content mb-4">
                    {data.locale === 'pt' ? 'Coment√°rios' : 'Comments'} üí¨
                  </h3>
                  <Giscus locale={data.locale} />
                </div>
              )
            }
          </div>

          <!-- Sidebar with TOC -->
          {
            data.toc && headings.length > 0 && isFeatureEnabled('tableOfContents') && (
              <aside class="hidden lg:block">
                <div class="sticky top-20">
                  <TableOfContents headings={headings} locale={data.locale} />
                </div>
              </aside>
            )
          }
        </div>
      </div>
    </div>
  </article>
</BaseLayout>
