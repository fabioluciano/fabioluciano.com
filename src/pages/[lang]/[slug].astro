---
// =============================================================================
// Dynamic Post Page - Unified for all locales
// =============================================================================

import { render } from 'astro:content';
import PostLayout from '@/layouts/PostLayout.astro';
import { getAllPosts, getPostSlug, type Post } from '@/lib/posts';
import { getUrlPrefix, type Locale } from '@/lib/i18n';
import { LOCALES } from '@/config/locales';
import MDXImageWrapper from '@/components/mdx/MDXImageWrapper.astro';
import ImageModalWrapper from '@/components/mdx/ImageModalWrapper.astro';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  const paths: { params: { lang: string; slug: string }; props: { post: Post } }[] = [];

  for (const lang of LOCALES) {
    const localePosts = posts.filter((p) => p.data.locale === lang);
    for (const post of localePosts) {
      paths.push({
        params: { lang, slug: getPostSlug(post) },
        props: { post },
      });
    }
  }

  return paths;
}

const { lang } = Astro.params as { lang: Locale };
const { post } = Astro.props;

if (!post) {
  return Astro.redirect('/404');
}

const { Content, headings } = await render(post);

// Check if alternate locale version exists
const allPosts = await getAllPosts();
const alternateLang = lang === 'pt' ? 'en' : 'pt';

// Find alternate post using translationSlug or matching slug
let alternatePost = null;
if (post.data.translationSlug) {
  // If translationSlug is defined, find post with that slug in the other language
  alternatePost = allPosts.find(
    (p) => p.data.locale === alternateLang && getPostSlug(p) === post.data.translationSlug
  );
} else {
  // Fallback: look for a post with the same slug
  const slug = getPostSlug(post);
  alternatePost = allPosts.find(
    (p) => p.data.locale === alternateLang && getPostSlug(p) === slug
  );
}

const alternateUrl = alternatePost
  ? `${getUrlPrefix(alternateLang)}/${getPostSlug(alternatePost)}`
  : null;

// MDX components mapping - override img to use ImageModal
const mdxComponents = {
  img: MDXImageWrapper,
  ImageModal: ImageModalWrapper,
};
---

<PostLayout post={post} headings={headings} alternateLocaleUrl={alternateUrl}>
  <Content components={mdxComponents} />
</PostLayout>
