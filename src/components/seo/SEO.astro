---
// =============================================================================
// SEO Component - Meta tags, Open Graph, Twitter Cards, JSON-LD
// =============================================================================

import { getSiteConfig, getCanonicalUrl, getAuthorConfig } from '@/config';
import type { Locale } from '@/config';

interface Props {
  title: string;
  description: string;
  ogImage?: string;
  canonicalUrl?: string;
  noIndex?: boolean;
  locale?: Locale;
  type?: 'website' | 'article';
  publishedAt?: Date;
  updatedAt?: Date;
  tags?: string[];
}

const {
  title,
  description,
  ogImage,
  canonicalUrl,
  noIndex = false,
  locale = 'pt',
  type = 'website',
  publishedAt,
  updatedAt,
  tags,
} = Astro.props;

const config = getSiteConfig();
const author = getAuthorConfig();

// Build URLs
const siteUrl = config.site.url;
const currentPath = Astro.url.pathname;
const canonical = canonicalUrl || getCanonicalUrl(currentPath);
const image = ogImage
  ? ogImage.startsWith('http')
    ? ogImage
    : `${siteUrl}${ogImage}`
  : `${siteUrl}${config.seo.defaultImage}`;

// Alternate language URLs
const alternateLocale = locale === 'pt' ? 'en' : 'pt';
const alternateUrl = `${canonical}?lang=${alternateLocale}`;

// JSON-LD structured data
const jsonLd =
  type === 'article'
    ? {
        '@context': 'https://schema.org',
        '@type': 'BlogPosting',
        headline: title,
        description: description,
        image: image,
        author: {
          '@type': 'Person',
          name: author.author.name,
          url: siteUrl,
        },
        publisher: {
          '@type': 'Person',
          name: author.author.name,
          url: siteUrl,
        },
        datePublished: publishedAt?.toISOString(),
        dateModified: updatedAt?.toISOString() || publishedAt?.toISOString(),
        mainEntityOfPage: {
          '@type': 'WebPage',
          '@id': canonical,
        },
        keywords: tags?.join(', '),
      }
    : {
        '@context': 'https://schema.org',
        '@type': 'WebSite',
        name: config.site.title,
        description: config.site.description,
        url: siteUrl,
        author: {
          '@type': 'Person',
          name: author.author.name,
        },
      };
---

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<link rel="canonical" href={canonical} />

{noIndex && <meta name="robots" content="noindex, nofollow" />}

<!-- Language alternates -->
<link rel="alternate" hreflang={locale === 'pt' ? 'pt-BR' : 'en-US'} href={canonical} />
<link rel="alternate" hreflang={alternateLocale === 'pt' ? 'pt-BR' : 'en-US'} href={alternateUrl} />
<link rel="alternate" hreflang="x-default" href={canonical} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type === 'article' ? 'article' : 'website'} />
<meta property="og:url" content={canonical} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={image} />
<meta property="og:site_name" content={config.seo.openGraph.siteName} />
<meta property="og:locale" content={locale === 'pt' ? 'pt_BR' : 'en_US'} />

{
  type === 'article' && publishedAt && (
    <>
      <meta property="article:published_time" content={publishedAt.toISOString()} />
      {updatedAt && <meta property="article:modified_time" content={updatedAt.toISOString()} />}
      <meta property="article:author" content={author.author.name} />
      {tags?.map((tag) => <meta property="article:tag" content={tag} />)}
    </>
  )
}

<!-- Twitter -->
<meta name="twitter:card" content={config.seo.twitterCard} />
<meta name="twitter:url" content={canonical} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={image} />
{config.seo.twitterHandle && <meta name="twitter:site" content={config.seo.twitterHandle} />}
{config.seo.twitterHandle && <meta name="twitter:creator" content={config.seo.twitterHandle} />}

<!-- RSS Feed -->
<link
  rel="alternate"
  type="application/rss+xml"
  title={`${config.site.title} RSS Feed`}
  href="/rss.xml"
/>

<!-- JSON-LD Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
