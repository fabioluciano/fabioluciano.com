---
// =============================================================================
// PlantUMLWrapper - Astro wrapper for PlantUML with client hydration
// =============================================================================

import { ImageModal } from './ImageModal';
import { getPlantUMLUrl } from '@/lib/plantuml';

interface Props {
  code: string;
  alt?: string;
  caption?: string;
  format?: 'svg' | 'png';
  className?: string;
}

const { code, alt = 'PlantUML Diagram', caption, format = 'svg', className = '' } = Astro.props;

// Compute URL server-side (Node.js environment)
let cleanCode = code.trim();

// Replace transparent background with white, or inject white if not set
if (cleanCode.includes('backgroundColor transparent')) {
  cleanCode = cleanCode.replace(/backgroundColor\s+transparent/, 'backgroundColor white');
} else if (!cleanCode.includes('skinparam backgroundColor')) {
  // Insert skinparam after @startuml or similar
  cleanCode = cleanCode.replace(
    /(@start\w+)/,
    '$1\nskinparam backgroundColor white'
  );
}

const diagramUrl = getPlantUMLUrl(cleanCode, { format });
---

<div class={`my-8 not-prose ${className}`}>
  <ImageModal
    client:visible
    src={diagramUrl}
    alt={alt}
    caption={caption}
    fullWidth={true}
  />
</div>
