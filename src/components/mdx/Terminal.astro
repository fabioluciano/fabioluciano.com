---
// =============================================================================
// Terminal.astro - Terminal window with header, traffic lights, and copy button
// =============================================================================

interface Props {
  title?: string;
  hideHeader?: boolean;
  variant?: 'default' | 'primary' | 'secondary' | 'accent' | 'neutral' | 'info' | 'success' | 'warning' | 'error';
  class?: string;
}

const {
  title = 'Terminal',
  hideHeader = false,
  variant = 'default',
  class: className = ''
} = Astro.props;

const variantClasses: Record<string, string> = {
  default: 'bg-neutral text-neutral-content',
  primary: 'bg-primary text-primary-content',
  secondary: 'bg-secondary text-secondary-content',
  accent: 'bg-accent text-accent-content',
  neutral: 'bg-neutral text-neutral-content',
  info: 'bg-info text-info-content',
  success: 'bg-success text-success-content',
  warning: 'bg-warning text-warning-content',
  error: 'bg-error text-error-content',
};
---

<div class={`terminal-wrapper my-6 not-prose rounded-lg overflow-hidden border border-base-300 shadow-lg ${className}`}>
  {!hideHeader && (
    <div class="flex items-center gap-2 px-4 py-2 bg-base-300">
      <div class="flex gap-1.5">
        <div class="w-3 h-3 rounded-full bg-error"></div>
        <div class="w-3 h-3 rounded-full bg-warning"></div>
        <div class="w-3 h-3 rounded-full bg-success"></div>
      </div>
      <span class="flex-1 text-center text-sm text-base-content/60 font-medium">
        {title}
      </span>
      <button
        class="copy-btn p-1.5 rounded hover:bg-base-content/10 transition-colors"
        title="Copiar codigo"
        aria-label="Copiar codigo"
      >
        <svg class="copy-icon w-4 h-4 text-base-content/60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <svg class="check-icon w-4 h-4 text-success hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </button>
    </div>
  )}

  <div class={`terminal-content p-4 font-mono text-sm overflow-x-auto ${variantClasses[variant]}`}>
    <div class="space-y-1">
      <slot />
    </div>
  </div>
</div>

<script>
  function initCopyButtons() {
    document.querySelectorAll('.terminal-wrapper .copy-btn').forEach((btn) => {
      // Skip if already initialized
      if (btn.hasAttribute('data-initialized')) return;
      btn.setAttribute('data-initialized', 'true');

      btn.addEventListener('click', async () => {
        const terminal = btn.closest('.terminal-wrapper');
        const content = terminal?.querySelector('.terminal-content');
        if (!content) return;

        // Get all command text content
        const lines: string[] = [];
        content.querySelectorAll('[data-command]').forEach((el) => {
          lines.push(el.textContent || '');
        });
        const text = lines.length > 0 ? lines.join('\n') : content.textContent || '';

        try {
          await navigator.clipboard.writeText(text);

          // Show success feedback
          const copyIcon = btn.querySelector('.copy-icon');
          const checkIcon = btn.querySelector('.check-icon');
          copyIcon?.classList.add('hidden');
          checkIcon?.classList.remove('hidden');

          setTimeout(() => {
            copyIcon?.classList.remove('hidden');
            checkIcon?.classList.add('hidden');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  }

  // Initialize on page load
  initCopyButtons();

  // Re-initialize on Astro page transitions (View Transitions)
  document.addEventListener('astro:page-load', initCopyButtons);
</script>
